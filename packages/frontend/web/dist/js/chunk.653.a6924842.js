"use strict";(globalThis.webpackChunk_affine_web=globalThis.webpackChunk_affine_web||[]).push([[653],{80653:(e,a,t)=>{t.r(a),t.d(a,{Component:()=>aG,DetailPage:()=>aq});var s=t(36870),o=t(4588),r=t(89716),i=t(66578),n=t(50233),l=t(6503),c=t(4892),d=t(75912),p=t(10871),u=t(83904),m=t(69050),f=t(45483),h=t(10980),x=t(61569),g=t(58507),j=t(17049),y=t(33907),v=t(16146),b=t(70154),k=t(37064),w=t(86326),C=t(42277),$=t(61362),S=t(90024),I=t(99646),N=t(77846),M=t(71006),D=t(49791),E=t(5863),_=t(24069);let O=new WeakMap;function P(e,a){let t=function(e,a){O.has(e)||O.set(e,new Map);let t=O.get(e);if((0,M.Z1)(t),t.has(a))return t.get(a);{let s=(0,D.eU)(e.getDoc(a)?.meta?.title||"Untitled");return s.onMount=t=>{let s=e.meta.docMetaUpdated.on(()=>{let s=e.getDoc(a);t(s?.meta?.title||"Untitled")});return()=>{s.dispose()}},t.set(a,s),s}}(e,a);(0,M.Z1)(t);let s=(0,E.md)(t),{localizedJournalDate:o}=(0,_.Bn)(e,a);return o||s}var F=t(94002),T=t(61953),B=t(52114),L=t(24312),R=t(55137),U=t(16820);let A=(0,D.eU)({open:!1,pageId:""});var Y=t(43685),V=t(48092),X=t(43392),z=t(52490),W=t(21817),H=t(73711),Z=t(96269),K=t(89679),q=t(14486),G=t(52600);let J=new z.k("page-history"),Q=(e,a)=>{let{data:t,loadingMore:s,loadMore:o}=(0,q.e6)({query:W.DX,getVariables:(t,s)=>({pageDocId:a,workspaceId:e,before:s?.workspace.histories.at(-1)?.timestamp,take:10})}),r=(0,w.useMemo)(()=>{if(!t)return!1;let e=t.at(-1);return!!e&&10===e.workspace.histories.length},[t]);return[(0,w.useMemo)(()=>t?t.flatMap(e=>e.workspace.histories):[],[t]),!!r&&o,!!s]},ee=async([e,a,t])=>{if(!t)return null;let s=await fetch(`/api/workspaces/${e}/docs/${a}/histories/${t}`);if(!s.ok)throw Error("Failed to fetch snapshot");let o=await s.arrayBuffer();if(!o)throw Error("Invalid snapshot");return o},ea=new Map,et=e=>{let a=ea.get(e);if(!a){let t=new G.c(e);a=new H.rl({id:e,blobSources:{main:t},schema:v.G,disableBacklinkIndex:!0,disableSearchIndex:!0}),ea.set(e,a),a.doc.emit("sync",[!0,a.doc])}return a},es=(e,a,t)=>{let{data:s}=(0,Z.A)([e,a,t],{fetcher:ee,suspense:!1});return s??void 0},eo=(e,a,t)=>{let s=es(e.id,a,t),o=(0,w.useMemo)(()=>{if(!t)return;let o=a+"-"+t,r=et(e.id),i=r.getDoc(o);if(!i&&s){(i=r.createDoc({id:o})).awarenessStore.setReadonly(i.blockCollection,!0);let e=i.spaceDoc;i.load(()=>{(0,U.applyUpdate)(e,new Uint8Array(s)),r.schema.upgradeDoc(0,{},e)})}return i??void 0},[a,s,t,e]);return(0,w.useEffect)(()=>{let a=et(e.id),t=(0,U.encodeStateAsUpdate)(e.doc);(0,U.applyUpdate)(a.doc,t)},[e]),o},er=e=>{let a=new Map;for(let t of e){let e=(0,L.U$)(t.timestamp,{relative:{max:[1,"week"],accuracy:"day",weekday:!0},absolute:{accuracy:"day",noYear:!0}}),s=a.get(e)??[];s.push(t),a.set(e,s)}return[...a.entries()]},ei=(e,a)=>{let t=(0,X.D)(e,a),s=(0,K.i)(),{trigger:o,isMutating:r}=(0,K.n)({mutation:W.C8}),{getDocMeta:i,setDocTitle:n}=(0,c.B)(e);return{onRestore:(0,w.useMemo)(()=>async(r,l)=>{if(!t)return;let c=t.spaceDoc.guid;!function(e,a,t){let s=new U.Doc;(0,U.applyUpdate)(s,a);let o=(0,U.encodeStateVector)(e),r=(0,U.encodeStateVector)(s),i=(0,U.encodeStateAsUpdate)(e,r),n=new U.UndoManager([...s.share.keys()].map(e=>{let a=t(e);if("Text"===a)return s.getText(e);if("Map"===a)return s.getMap(e);if("Array"===a)return s.getArray(e);throw Error("Unknown type")}));(0,U.applyUpdate)(s,i),n.undo();let l=(0,U.encodeStateAsUpdate)(s,o);(0,U.applyUpdate)(e,l)}(t.spaceDoc,l,e=>((0,M.U2)(e,"blocks"),"Map"));let d=t.meta?.title??"";i(a)?.title!==d&&n(a,d),await o({docId:c,timestamp:r,workspaceId:e.id}),await s(W.DX,a=>a.pageDocId===c&&a.workspaceId===e.id),J.info("Page restored",c,r)},[i,s,t,a,o,n,e.id]),isMutating:r}},en=()=>(0,s.jsxs)("svg",{width:"200",height:"174",viewBox:"0 0 200 174",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,s.jsx)("rect",{x:"51.724",y:"38.4615",width:"96.5517",height:"96.5517",stroke:"var(--affine-text-disable-color)"}),(0,s.jsx)("path",{d:"M51.8339 86.7374L99.9999 38.5714L148.166 86.7374L99.9999 134.903L51.8339 86.7374Z",stroke:"var(--affine-text-disable-color)"}),(0,s.jsx)("path",{d:"M99.6052 38.1966C107.662 33.4757 117.043 30.7695 127.055 30.7695C157.087 30.7695 181.432 55.1148 181.432 85.1462C181.432 107.547 167.887 126.783 148.541 135.113",stroke:"var(--affine-text-disable-color)"}),(0,s.jsx)("path",{d:"M148.375 86.4722C153.096 94.5291 155.802 103.91 155.802 113.922C155.802 143.954 131.457 168.299 101.426 168.299C79.0254 168.299 59.7886 154.754 51.4587 135.408",stroke:"var(--affine-text-disable-color)"}),(0,s.jsx)("path",{d:"M100.394 135.113C92.3373 139.834 82.9568 142.54 72.9441 142.54C42.9127 142.54 18.5675 118.195 18.5675 88.1634C18.5675 65.763 32.1124 46.5261 51.4587 38.1963",stroke:"var(--affine-text-disable-color)"}),(0,s.jsx)("path",{d:"M51.4585 87.1318C46.7377 79.0749 44.0315 69.6943 44.0315 59.6817C44.0315 29.6503 68.3767 5.30503 98.4081 5.30503C120.809 5.30503 140.045 18.8499 148.375 38.1963",stroke:"var(--affine-text-disable-color)"}),(0,s.jsx)("path",{d:"M51.4587 38.1963L148.541 135.279",stroke:"var(--affine-text-disable-color)"}),(0,s.jsx)("path",{d:"M148.541 38.1963L51.4587 135.279",stroke:"var(--affine-text-disable-color)"}),(0,s.jsx)("path",{d:"M99.9998 38.1963V135.279",stroke:"var(--affine-text-disable-color)"}),(0,s.jsx)("path",{d:"M148.541 86.7378L51.4588 86.7378",stroke:"var(--affine-text-disable-color)"}),(0,s.jsx)("ellipse",{cx:"148.275",cy:"38.4617",rx:"3.97878",ry:"3.97878",fill:"var(--affine-text-primary-color)"}),(0,s.jsx)("ellipse",{cx:"148.275",cy:"135.013",rx:"3.97878",ry:"3.97878",fill:"var(--affine-text-primary-color)"}),(0,s.jsx)("ellipse",{cx:"148.275",cy:"86.7376",rx:"3.97878",ry:"3.97878",fill:"var(--affine-text-primary-color)"}),(0,s.jsx)("ellipse",{cx:"51.7241",cy:"38.4617",rx:"3.97878",ry:"3.97878",fill:"var(--affine-text-primary-color)"}),(0,s.jsx)("ellipse",{cx:"51.7241",cy:"135.013",rx:"3.97878",ry:"3.97878",fill:"var(--affine-text-primary-color)"}),(0,s.jsx)("ellipse",{cx:"51.7241",cy:"86.7376",rx:"3.97878",ry:"3.97878",fill:"var(--affine-text-primary-color)"}),(0,s.jsx)("ellipse",{cx:"100",cy:"38.4617",rx:"3.97878",ry:"3.97878",transform:"rotate(-90 100 38.4617)",fill:"var(--affine-text-primary-color)"}),(0,s.jsx)("ellipse",{cx:"100",cy:"86.2073",rx:"3.97878",ry:"3.97878",transform:"rotate(-90 100 86.2073)",fill:"var(--affine-text-primary-color)"}),(0,s.jsx)("ellipse",{cx:"100",cy:"135.013",rx:"3.97878",ry:"3.97878",transform:"rotate(-90 100 135.013)",fill:"var(--affine-text-primary-color)"})]});var el="_9fbys55";let ec={"data-testid":"page-history-modal",onPointerDownOutside:e=>{e.preventDefault()},style:{padding:0,maxWidth:944,backgroundColor:"var(--affine-background-primary-color)",overflow:"hidden"}},ed=({onOpenChange:e,open:a,children:t})=>(0,s.jsx)(I.aF,{open:a,onOpenChange:e,width:"calc(100% - 64px)",height:"80%",withoutCloseButton:!0,contentOptions:ec,children:t}),ep=({ts:e,historyList:a,snapshotPage:t,onModeChange:r,mode:i,title:n})=>{let l=(0,w.useCallback)(e=>{F.u4.$.docHistory.$.switchPageMode({mode:e}),r(e)},[r]),c=(0,w.useMemo)(()=>(0,s.jsxs)("div",{className:"_9fbys58",children:[(0,s.jsxs)("div",{className:"_9fbys59",children:[(0,s.jsx)(V.H,{mode:i,setMode:l}),(0,s.jsx)("div",{className:"_9fbys5a",children:n}),(0,s.jsx)("div",{className:"_9fbys5b",children:e?(0,L.U$)(e,{absolute:{accuracy:"minute",noDate:!0}}):null})]}),t?(0,s.jsx)($.E,{children:(0,s.jsxs)(o.yE.Root,{children:[(0,s.jsx)(o.yE.Viewport,{className:"affine-page-viewport",children:(0,s.jsx)(Y.H,{className:"_9fbys5c",mode:i,page:t})}),(0,s.jsx)(o.yE.Scrollbar,{})]})}):(0,s.jsx)("div",{className:"_9fbys5e",children:(0,s.jsx)(o.Rh,{size:24})})]}),[i,l,t,n,e]);return(0,s.jsx)("div",{className:"_9fbys56",children:a.map((t,o)=>{let r=a.findIndex(a=>a.timestamp===e),i=o-r,n=i>20?"> 20":i<-20?"< -20":i.toString();return(0,s.jsx)("div",{"data-distance":n,className:"_9fbys57",children:r===o?c:null},o)})})},eu=(0,D.eU)(!1),em=()=>{let e=(0,h.h1)(B.P);(0,w.useEffect)(()=>{e.quota.revalidate()},[e]);let a=(0,x.S)(e.quota.quota$),t=(0,w.useMemo)(()=>a?"free"!==a.humanReadable.name.toLowerCase():null,[a]),o=(0,h.h1)(T.Q),r=(0,x.S)(o.permission.isOwner$);(0,w.useEffect)(()=>{o.permission.revalidate()},[o]);let i=(0,E.Xr)(N.JO),[n,l]=(0,E.fp)(eu),c=(0,w.useCallback)(()=>{l(!0)},[l]),d=(0,w.useCallback)(()=>{i({open:!0,activeTab:"plans",scrollAnchor:"cloudPricingPlan"}),F.u4.$.docHistory.$.viewPlans()},[i]),p=(0,L.s9)(),u=(0,w.useMemo)(()=>(0,s.jsxs)("div",{className:"_9fbys5x",children:[null!==t?t?p["com.affine.history.confirm-restore-modal.plan-prompt.title"]():p["com.affine.history.confirm-restore-modal.plan-prompt.limited-title"]():"",(0,s.jsx)(S.K0,{onClick:c,children:(0,s.jsx)(f.CloseIcon,{})})]}),[c,t,p]),m=(0,w.useMemo)(()=>t?(0,s.jsxs)(L.x6,{i18nKey:"com.affine.history.confirm-restore-modal.pro-plan-prompt.description",children:["With the workspace creator's Pro account, every member enjoys the privilege of accessing up to ",(0,s.jsx)("b",{children:"30 days"})," of version history."]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(L.x6,{i18nKey:"com.affine.history.confirm-restore-modal.free-plan-prompt.description",children:["With the workspace creator's Free account, every member can access up to ",(0,s.jsx)("b",{children:"7 days"})," of version history."]}),r?(0,s.jsx)("span",{className:"_9fbys5y",onClick:d,children:p["com.affine.history.confirm-restore-modal.pro-plan-prompt.upgrade"]()}):null]}),[r,t,d,p]);return n?null:(0,s.jsx)("div",{className:"_9fbys5v",children:(0,s.jsxs)("div",{className:"_9fbys5w",children:[u,m]})})},ef=({historyList:e,onLoadMore:a,loadingMore:t,activeVersion:r,onVersionChange:i})=>{let n=(0,L.s9)(),l=(0,w.useMemo)(()=>er(e),[e]),[c,d]=(0,w.useState)({});return(0,w.useLayoutEffect)(()=>{e.length>0&&!r&&i(e[0].timestamp)},[r,e,i]),(0,s.jsxs)("div",{className:"_9fbys5f",children:[(0,s.jsx)("div",{className:"_9fbys5i",children:n["com.affine.history.version-history"]()}),(0,s.jsxs)(o.yE.Root,{className:"_9fbys5g",children:[(0,s.jsxs)(o.yE.Viewport,{className:"_9fbys5h",children:[(0,s.jsx)(em,{}),l.map(([e,a],t)=>{let o=c[t];return(0,s.jsxs)(R.bL,{open:!o,className:"_9fbys5j",children:[(0,s.jsxs)(R.l9,{role:"button",onClick:()=>d(e=>({...e,[t]:!o})),className:"_9fbys5k",children:[(0,s.jsx)("div",{"data-testid":"page-list-group-header-collapsed-button",className:"_9fbys5u",children:(0,s.jsx)(f.ToggleCollapseIcon,{className:"_9fbys5t","data-collapsed":!!o})}),e]}),(0,s.jsx)(R.UC,{children:a.map((e,t)=>(0,s.jsxs)(w.Fragment,{children:[(0,s.jsx)("div",{className:"_9fbys5l _9fbys5d","data-testid":"version-history-item",onClick:a=>{a.stopPropagation(),i(e.timestamp)},"data-active":r===e.timestamp,children:(0,s.jsx)("button",{children:(0,L.U$)(e.timestamp,{absolute:{noDate:!0,accuracy:"minute"}})})}),t>a.length-1?(0,s.jsx)("div",{className:"_9fbys5m _9fbys5d"}):null]},e.timestamp))})]},e)}),a?(0,s.jsx)(S.$n,{variant:"plain",loading:t,disabled:t,className:"_9fbys5n _9fbys5l _9fbys5d",onClick:a,children:n["com.affine.history.confirm-restore-modal.load-more"]()}):null]}),(0,s.jsx)(o.yE.Scrollbar,{})]})]})},eh=()=>{let e=(0,L.s9)();return(0,s.jsxs)("div",{className:"_9fbys5q","data-testid":"empty-history-prompt",children:[(0,s.jsx)(en,{}),(0,s.jsx)("div",{className:"_9fbys5r",children:e["com.affine.history.empty-prompt.title"]()}),(0,s.jsx)("div",{className:"_9fbys5s",children:e["com.affine.history.empty-prompt.description"]()})]})},ex=({docCollection:e,pageId:a,onClose:t})=>{let o=e.id,[r,i]=(0,w.useState)(),n=(0,w.useMemo)(()=>e.getDoc(a)?.spaceDoc.guid??a,[a,e]),{openConfirmModal:l}=(0,I.fl)(),c=eo(e,n,r),d=(0,L.s9)(),{onRestore:p,isMutating:u}=ei(e,a),m=(0,w.useMemo)(()=>async()=>{if(!r||!c)return;let e=(0,U.encodeStateAsUpdate)(c.spaceDoc);await p(r,new Uint8Array(e)),t()},[r,t,p,c]),f=(0,h.h1)(g.s).doc,[x,j]=(0,w.useState)(f.mode$.value),y=P(e,a),v=(0,w.useCallback)(()=>{l({title:d["com.affine.history.restore-current-version"](),description:d["com.affine.history.confirm-restore-modal.hint"](),cancelText:d.Cancel(),contentOptions:{"data-testid":"confirm-restore-history-modal",style:{padding:"20px 26px"}},confirmText:d["com.affine.history.confirm-restore-modal.restore"](),confirmButtonOptions:{variant:"primary","data-testid":"confirm-restore-history-button"},onConfirm:m})},[m,l,d]),[b,k,C]=Q(o,n);return(0,s.jsxs)("div",{className:"_9fbys54",children:[(0,s.jsxs)("div",{className:el,"data-empty":!r,children:[(0,s.jsx)(ep,{ts:r,historyList:b,snapshotPage:c,mode:x,onModeChange:j,title:y}),(0,s.jsx)(ef,{historyList:b,onLoadMore:k,loadingMore:C,activeVersion:r,onVersionChange:i})]}),r?null:(0,s.jsx)("div",{className:el,children:(0,s.jsx)(eh,{})}),(0,s.jsxs)("div",{className:"_9fbys5o",children:[(0,s.jsx)(S.$n,{onClick:t,children:d["com.affine.history.back-to-page"]()}),(0,s.jsx)("div",{className:"_9fbys5p"}),(0,s.jsx)(S.$n,{variant:"primary",onClick:v,disabled:u||!r,children:d["com.affine.history.restore-current-version"]()})]})]})},eg=({onOpenChange:e,open:a,pageId:t,docCollection:o})=>{let i=(0,w.useCallback)(()=>{e(!1)},[e]);return(0,s.jsx)(ed,{onOpenChange:e,open:a,children:(0,s.jsx)(w.Suspense,{fallback:(0,s.jsx)(r.a,{}),children:(0,s.jsx)(ex,{onClose:i,pageId:t,docCollection:o})})})},ej=()=>{let[{open:e,pageId:a},t]=(0,E.fp)(A),o=(0,h.h1)(j.j).workspace,r=(0,w.useCallback)(e=>{F.u4.$.docHistory.$[e?"open":"close"](),t(a=>({...a,open:e}))},[t]);return(0,s.jsx)(eg,{open:e,onOpenChange:r,pageId:a,docCollection:o.docCollection})};var ey=t(45609),ev=t(92781),eb=t(69628),ek=t(93965),ew=t(86639),eC="_2r0hpk3",e$="_2r0hpk4";let eS=()=>{let e=(0,h.h1)(j.j).workspace,a=e.docCollection,t=(0,h.h1)(g.s).doc,o=(0,L.s9)(),{appSettings:r}=(0,l.V)(),{jumpToSubPath:i}=(0,eb.P)(),{restoreFromTrash:n}=(0,ev._)(a),[c,d]=(0,w.useState)(!1),p=o["com.affine.cmdk.affine.editor.trash-footer-hint"](),u=(0,w.useCallback)(()=>{n(t.id),(0,ew.oR)(o["com.affine.toastMessage.restored"]({title:t.meta$.value.title||"Untitled"}))},[t.id,t.meta$.value.title,n,o]),m=(0,w.useCallback)(()=>{i(e.id,ek.Tk.ALL),a.removeDoc(t.id),(0,ew.oR)(o["com.affine.toastMessage.permanentlyDeleted"]())},[i,e.id,a,t.id,o]),x=(0,w.useCallback)(()=>{d(!0)},[]);return(0,s.jsxs)("div",{className:"_2r0hpk1","data-has-background":!r.clientBorder,children:[(0,s.jsx)("div",{className:"_2r0hpk2",children:p}),(0,s.jsxs)("div",{className:"_2r0hpk0",children:[(0,s.jsx)(S.$n,{tooltip:o["com.affine.trashOperation.restoreIt"](),"data-testid":"page-restore-button",variant:"primary",onClick:u,className:eC,prefix:(0,s.jsx)(f.ResetIcon,{}),prefixClassName:e$}),(0,s.jsx)(S.$n,{tooltip:o["com.affine.trashOperation.deletePermanently"](),variant:"error",onClick:x,className:eC,prefix:(0,s.jsx)(f.DeleteIcon,{}),prefixClassName:e$})]}),(0,s.jsx)(I.uo,{title:o["com.affine.trashOperation.delete.title"](),cancelText:o["com.affine.confirmModal.button.cancel"](),description:o["com.affine.trashOperation.delete.description"](),confirmText:o["com.affine.trashOperation.delete"](),confirmButtonOptions:{variant:"error"},open:c,onConfirm:m,onOpenChange:d})]})},eI=({show:e,onClose:a,message:t})=>e?(0,s.jsxs)("div",{className:"_57ftle0",children:[t,(0,s.jsx)("div",{className:"_57ftle1",onClick:a,children:(0,s.jsx)(f.CloseIcon,{className:"_57ftle2"})})]}):null;var eN=t(99971);let eM=({onClose:e,isLoggedIn:a,onLogin:t,onEnableCloud:o})=>{let r=(0,L.s9)(),i=a?r["Enable AFFiNE Cloud"]():r["Sign in and Enable"](),n=(0,w.useCallback)(()=>a?o():t(),[a,o,t]);return(0,s.jsxs)("div",{className:"_57ftle3","data-testid":"local-demo-tips",children:[(0,s.jsx)("div",{className:"_57ftle4",children:r["com.affine.banner.local-warning"]()}),(0,s.jsxs)("div",{className:"_57ftle5",children:[(0,s.jsx)(S.$n,{style:{background:(0,eN.Vg)("white")},onClick:n,children:i}),(0,s.jsx)(S.K0,{onClick:e,size:"20","data-testid":"local-demo-tips-close-button",children:(0,s.jsx)(f.CloseIcon,{})})]})]})};var eD=t(21823),eE=t(38711),e_=t(59481);let eO=!environment.isDesktop&&!!environment.isBrowser&&(!!environment.isMobile||!!environment.isChrome&&environment.chromeVersion<106),eP=()=>{let e=(0,L.s9)(),a=environment.isBrowser&&!environment.isChrome,t=environment.isBrowser&&environment.isChrome&&environment.chromeVersion<106;return"isMobile"in environment&&environment.isMobile?(0,s.jsx)("span",{children:e["com.affine.top-tip.mobile"]()}):a?(0,s.jsx)("span",{children:(0,s.jsxs)(L.x6,{i18nKey:"recommendBrowser",children:["We recommend the ",(0,s.jsx)("strong",{children:"Chrome"})," browser for an optimal experience."]})}):t?(0,s.jsx)("span",{children:e.upgradeBrowser()}):null},eF=({pageId:e,workspace:a})=>{let t=(0,x.S)((0,h.h1)(e_.uR).session.status$),[o,r]=(0,w.useState)(eO),[i,n]=(0,w.useState)(!0),l=(0,eE.K)(),c=(0,E.Xr)(N.W7),d=(0,w.useCallback)(()=>{c({openModal:!0,state:"signIn"})},[c]);return i&&!environment.isDesktop&&a.flavour===eD.j.LOCAL?(0,s.jsx)(eM,{isLoggedIn:"authenticated"===t,onLogin:d,onEnableCloud:()=>l(a,{openPageId:e}),onClose:()=>{n(!1)}}):(0,s.jsx)(eI,{show:o,message:(0,s.jsx)(eP,{}),onClose:()=>{r(!1)}})};var eT=t(23110),eB=t(16439),eL=t(37272),eR=t(81427),eU=t(30397);async function eA({page:e,type:a}){let t=document.querySelector("editor-host"),s=null;switch(t&&(s=t.spec.getService("affine:page")),F.u4.$.sharePanel.$.export({type:a}),a){case"html":await u.FZ8.exportDoc(e);break;case"markdown":await u.TG.exportDoc(e);break;case"pdf":if(environment.isDesktop&&e.meta?.mode==="page")await eR.Ok?.export.savePDFFileAs(e.root.title.toString());else{if(!s)return;await s.exportManager.exportPdf()}break;case"png":if(!s)return;await s.exportManager.exportPng()}}let eY=e=>{let a=(0,E.Xr)(eL.$A),t=(0,E.Xr)(eL.p0),s=(0,L.s9)();return(0,w.useCallback)(async r=>{let i=(0,eU.Ak)();a({key:i});try{await eA({page:e,type:r}),o.me.success({title:s["com.affine.export.success.title"](),message:s["com.affine.export.success.message"]()})}catch(e){console.error(e),o.me.error({title:s["com.affine.export.error.title"](),message:s["com.affine.export.error.message"]()})}finally{t(i)}},[e,a,t,s])};var eV=t(80696),eX=t(40274),ez=t(90039),eW=t(50277),eH=t(26582),eZ=t(47265),eK=t(6427);let eq=e=>{let a=(0,L.s9)(),t=(0,h.h1)(eB.Mn),s=(0,x.S)(t.isFavorite$(e,"doc")),o=(0,w.useCallback)(()=>{t.toggle(e,"doc"),(0,ew.oR)(s?a["com.affine.toastMessage.removedFavorites"]():a["com.affine.toastMessage.addedFavorites"]())},[s,e,a,t]);return{favorite:s,toggleFavorite:o}},eG=({pageId:e})=>{let{favorite:a,toggleFavorite:t}=eq(e),o=(0,w.useCallback)(()=>{F.u4.$.header.actions.toggleFavorite(),t()},[t]);return(0,s.jsx)(eK.f6,{"data-testid":"pin-button",active:!!a,onClick:o})},eJ=()=>{let e=(0,E.Xr)(N.hX),a=(0,L.s9)(),t=(0,w.useCallback)(()=>{F.u4.$.header.actions.openDocInfo(),e(!0)},[e]);return(0,s.jsx)(o.K0,{size:"20",tooltip:a["com.affine.page-properties.page-info.view"](),"data-testid":"header-info-button",onClick:t,children:(0,s.jsx)(f.InformationIcon,{})})};var eQ=t(94343),e0=t.n(eQ);let e1={maxWidth:800,width:"100%"},e9=({docCollection:e,page:a})=>{let t=(0,w.useRef)(null),{journalDate:r}=(0,_.Bn)(e,a.id),{openJournal:i}=(0,_.mM)(e),[n,l]=(0,w.useState)((r??e0()()).format("YYYY-MM-DD"));return(0,w.useEffect)(()=>{r&&(l(r.format("YYYY-MM-DD")),t.current?.setCursor?.(r))},[r]),(0,s.jsx)(o.bC,{handleRef:t,style:e1,value:n,onChange:i})},e4=({docCollection:e})=>{let a=(0,L.s9)(),t=(0,_.mM)(e),r=(0,w.useCallback)(()=>{t.openToday()},[t]);return(0,s.jsx)(o.$n,{size:"default",onClick:r,style:{height:32,padding:"0px 8px"},children:a["com.affine.today"]()})};var e5=t(66216),e8=t(63035),e3=t(8055),e7="_1yta8g3b",e2="_1yta8g33",e6="_1yta8g32",ae="_1yta8g31",aa="_1yta8g3c",at="_1yta8g39",as=t(796);let ao=({workspaceId:e,pageId:a,urlType:t,blockId:s})=>{let o=(0,as.T)();if(!o)return null;try{return new URL(`${o}/${t}/${e}/${a}${"workspace"===t&&s?`#${s}`:""}`).toString()}catch(e){return null}},ar=({workspaceId:e,pageId:a,urlType:t})=>{let s=(0,L.s9)(),[r,i]=(0,w.useState)(""),[n]=(0,eX.U)(),l=(0,w.useMemo)(()=>ao({workspaceId:e,pageId:a,urlType:t,blockId:r.length>0?r:void 0}),[e,a,t,r]),c=(0,w.useCallback)(()=>{l?(navigator.clipboard.writeText(l).then(()=>{o.me.success({title:s["Copied link to clipboard"]()})}).catch(e=>{console.error(e)}),F.u4.$.sharePanel.$.copyShareLink({type:"share"===t?"public":"private"})):o.me.error({title:"Network not available"})},[l,s,t]);return(0,w.useEffect)(()=>{let e=null,a=n?.host?.selection;if("workspace"!==t||!a)return;let s=a.find("block");return s&&i(`#${s.blockId}`),e=a.slots.changed.on(e=>{i(a=>e[0]&&"block"===e[0].type?`#${e[0].blockId}`:a.length>0?"":a)}),()=>{e?.dispose()}},[n?.host?.selection,t]),{sharingUrl:l,onClickCopyLink:c}},ai=({workspaceMetadata:e,currentPage:a})=>{let t=(0,L.s9)(),r=(0,h.h1)(g.s).doc,{sharingUrl:i,onClickCopyLink:n}=ar({workspaceId:e.id,pageId:a.id,urlType:"workspace"}),l=eY(a),c=(0,x.S)(r.mode$),d=environment.isBrowser&&environment.isMacOs;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:at,children:t["com.affine.share-menu.ShareViaExport"]()}),(0,s.jsx)("div",{className:e2,children:t["com.affine.share-menu.ShareViaExportDescription"]()}),(0,s.jsx)("div",{children:(0,s.jsx)(eK.uw,{exportHandler:l,className:e6,pageMode:c})}),e.flavour!==eD.j.LOCAL?(0,s.jsxs)("div",{className:e7,children:[(0,s.jsx)(e8.c,{size:"thinner"}),(0,s.jsx)("div",{className:at,children:t["com.affine.share-menu.share-privately"]()}),(0,s.jsx)("div",{className:e2,children:t["com.affine.share-menu.share-privately.description"]()}),(0,s.jsx)("div",{children:(0,s.jsx)(o.Dr,{className:"_1yta8g3j",onSelect:n,block:!0,disabled:!i,preFix:(0,s.jsx)(o.ZB,{children:(0,s.jsx)(f.CopyIcon,{fontSize:16})}),endFix:(0,s.jsx)("div",{className:"_1yta8g3l",children:d?"⌘ + ⌥ + C":"Ctrl + Shift + C"}),children:t["com.affine.share-menu.copy-private-link"]()})})]}):null]})};var an=t(20464),al=t(4285),ac=t(53216),ad=t(31523),ap=t(7776);let au=e=>{let a=(0,L.s9)();return(0,s.jsxs)("div",{className:"_1yta8g3g",children:[(0,s.jsxs)("div",{className:e7,style:{gap:"12px"},children:[(0,s.jsx)("div",{className:e2,style:{maxWidth:"230px"},children:a["com.affine.share-menu.EnableCloudDescription"]()}),(0,s.jsx)("div",{children:(0,s.jsx)(S.$n,{onClick:e.onEnableAffineCloud,variant:"primary","data-testid":"share-menu-enable-affine-cloud-button",children:a["Enable AFFiNE Cloud"]()})})]}),(0,s.jsx)("div",{className:"_1yta8g3h",children:(0,s.jsx)(ap.u,{})})]})},am=e=>{let{workspaceMetadata:{id:a}}=e,t=(0,h.h1)(g.s).doc,r=(0,h.h1)(e3.Dw),i=(0,h.h1)(e_.BB).serverConfig;(0,w.useEffect)(()=>{r.share.revalidate()},[r]);let n=(0,x.S)(r.share.isShared$),l=(0,x.S)(r.share.sharedMode$),c=(0,x.S)(i.config$.map(e=>e?.baseUrl)),d=null===n||null===l||null===c,[p,u]=(0,w.useState)(!1),m=(0,x.S)(t.mode$),j=(0,w.useMemo)(()=>n&&l?l.toLowerCase():m,[m,n,l]),{sharingUrl:y,onClickCopyLink:v}=ar({workspaceId:a,pageId:t.id,urlType:"share"}),b=(0,L.s9)(),k=(0,w.useMemo)(()=>[{value:"page",label:b["com.affine.pageMode.page"]()},{value:"edgeless",label:b["com.affine.pageMode.edgeless"]()}],[b]),C=(0,al.V)(async()=>{try{await r.share.enableShare("edgeless"===j?ac.Yh.Edgeless:ac.Yh.Page),F.u4.$.sharePanel.$.createShareLink({mode:j}),o.me.success({title:b["com.affine.share-menu.create-public-link.notification.success.title"](),message:b["com.affine.share-menu.create-public-link.notification.success.message"](),style:"normal",icon:(0,s.jsx)(f.SingleSelectSelectSolidIcon,{color:(0,eN.Vg)("primaryColor")})}),y&&navigator.clipboard.writeText(y).catch(e=>{console.error(e)})}catch(e){o.me.error({title:b["com.affine.share-menu.confirm-modify-mode.notification.fail.title"](),message:b["com.affine.share-menu.confirm-modify-mode.notification.fail.message"]()}),console.error(e)}},[j,r.share,y,b]),$=(0,al.V)(async()=>{try{await r.share.disableShare(),o.me.error({title:b["com.affine.share-menu.disable-publish-link.notification.success.title"](),message:b["com.affine.share-menu.disable-publish-link.notification.success.message"]()})}catch(e){o.me.error({title:b["com.affine.share-menu.disable-publish-link.notification.fail.title"](),message:b["com.affine.share-menu.disable-publish-link.notification.fail.message"]()}),console.log(e)}u(!1)},[r,b]),I=(0,al.V)(async e=>{try{n&&(await r.share.changeShare("edgeless"===e?ac.Yh.Edgeless:ac.Yh.Page),o.me.success({title:b["com.affine.share-menu.confirm-modify-mode.notification.success.title"](),message:b["com.affine.share-menu.confirm-modify-mode.notification.success.message"]({preMode:"edgeless"===e?b.Page():b.Edgeless(),currentMode:"edgeless"===e?b.Edgeless():b.Page()}),style:"normal",icon:(0,s.jsx)(f.SingleSelectSelectSolidIcon,{color:(0,eN.Vg)("primaryColor")})}))}catch(e){o.me.error({title:b["com.affine.share-menu.confirm-modify-mode.notification.fail.title"](),message:b["com.affine.share-menu.confirm-modify-mode.notification.fail.message"]()}),console.error(e)}},[n,r.share,b]);return d?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(o.EA,{height:100}),(0,s.jsx)(o.EA,{height:40})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:at,children:b["com.affine.share-menu.publish-to-web"]()}),(0,s.jsx)("div",{className:e7,children:(0,s.jsx)("div",{className:e2,children:b["com.affine.share-menu.publish-to-web.description"]()})}),(0,s.jsxs)("div",{className:aa,children:[(0,s.jsx)(o.pd,{inputStyle:{color:"var(--affine-text-secondary-color)",fontSize:"var(--affine-font-xs)",lineHeight:"20px"},value:n&&y||`${c}/...`,readOnly:!0}),n?(0,s.jsx)(S.$n,{onClick:v,"data-testid":"share-menu-copy-link-button",style:{padding:"4px 12px",whiteSpace:"nowrap"},disabled:!y,children:b.Copy()}):(0,s.jsx)(S.$n,{onClick:C,variant:"primary","data-testid":"share-menu-create-link-button",style:{padding:"4px 12px",whiteSpace:"nowrap"},children:b.Create()})]}),(0,s.jsxs)("div",{className:aa,children:[(0,s.jsx)("div",{className:"_1yta8g3a",children:b["com.affine.share-menu.ShareMode"]()}),(0,s.jsx)("div",{children:(0,s.jsx)(o.z6,{className:"_1yta8g3d",value:j,onChange:I,items:k})})]}),n?(0,s.jsxs)(s.Fragment,{children:[!1,(0,s.jsx)(e5.Dr,{endFix:(0,s.jsx)(f.ArrowRightSmallIcon,{}),block:!0,type:"danger",className:e6,onSelect:e=>{e.preventDefault(),u(!0)},children:(0,s.jsx)("div",{className:"_1yta8g3f",children:b["Disable Public Link"]()})}),(0,s.jsx)(an.r,{open:p,onConfirm:$,onOpenChange:u})]}):null]})},af=e=>{if(e.workspaceMetadata.flavour===eD.j.LOCAL)return(0,s.jsx)(au,{...e});if(e.workspaceMetadata.flavour===eD.j.AFFINE_CLOUD)return(0,s.jsx)(ad.tH,{fallback:null,children:(0,s.jsx)(w.Suspense,{children:(0,s.jsx)(am,{...e})})});throw Error("Unreachable")},ah=e=>{let a=(0,L.s9)();return(0,s.jsxs)("div",{className:"_1yta8g36",children:[(0,s.jsxs)("div",{className:"_1yta8g30",children:[(0,s.jsx)("div",{className:"_1yta8g3i",children:(0,s.jsx)(f.WebIcon,{})}),a["com.affine.share-menu.SharePage"]()]}),(0,s.jsx)(af,{...e}),(0,s.jsx)("div",{className:e7,children:(0,s.jsx)(e8.c,{size:"thinner"})}),(0,s.jsx)(ai,{...e})]})},ax=(0,w.forwardRef)(function(e,a){let t=(0,L.s9)(),o=(0,h.h1)(e3.Dw),r=(0,x.S)(o.share.isShared$);return(0,w.useEffect)(()=>{o.share.revalidate()},[o]),(0,s.jsx)(S.$n,{ref:a,className:"_1yta8g3k",variant:"primary",children:r?t["com.affine.share-menu.sharedButton"]():t["com.affine.share-menu.shareButton"]()})}),ag=e=>(0,s.jsx)(e5.W1,{items:(0,s.jsx)(ah,{...e}),contentOptions:{className:ae,"data-testid":"local-share-menu"},rootOptions:{modal:!1,onOpenChange:e.onOpenShareModal},children:(0,s.jsx)("div",{"data-testid":"local-share-menu-button",children:e.children||(0,s.jsx)(ax,{})})}),aj=e=>(0,s.jsx)(e5.W1,{items:(0,s.jsx)(ah,{...e}),contentOptions:{className:ae,"data-testid":"cloud-share-menu"},rootOptions:{modal:!1,onOpenChange:e.onOpenShareModal},children:(0,s.jsx)("div",{"data-testid":"cloud-share-menu-button",children:e.children||(0,s.jsx)(ax,{})})}),ay=e=>{let{workspaceMetadata:a}=e;return a.flavour===eD.j.LOCAL?(0,s.jsx)(ag,{...e}):(0,s.jsx)(aj,{...e})};var av=t(69992);let ab=e=>{let a=(0,x.S)((0,h.h1)(g.s).doc.mode$),t=(0,h.h1)(eW.TR).workbench,s=(0,av.s)(),o=(0,x.S)(t.views$.map(e=>e.length)),r=(0,x.S)(t.sidebarOpen$),i=e<500||o>1,n=e<400||"edgeless"!==a,l=s.isLast&&!r&&!(n&&i)&&!environment.isDesktop;return{hideShare:i,hidePresent:n,hideCollect:e<300,hideToday:e<300,showDivider:l}},ak=(0,w.forwardRef)((e,a)=>(0,s.jsx)(S.K0,{ref:a,...e,"data-testid":"header-dropDownButton",className:"_14uy6a10",children:(0,s.jsx)(f.MoreHorizontalIcon,{})}));ak.displayName="HeaderDropDownButton";var aw=t(26605);let aC=({rename:e,page:a,isJournal:t,containerWidth:r})=>{let i=a?.id,n=(0,L.s9)(),{hideShare:l}=ab(r),c=(0,eE.K)(),d=(0,h.h1)(j.j).workspace,u=d.docCollection,m=(0,h.h1)(g.s).doc,y=(0,x.S)(m.meta$.map(e=>e.trash)),v=(0,x.S)(m.mode$),b=(0,h.h1)(eW.TR).workbench,{favorite:k,toggleFavorite:C}=eq(i),{duplicate:$}=(0,ev._)(u),{importFile:S}=(0,aw.z)(u),{setTrashModal:I}=(0,eV.T)(u),M=(0,h.h1)(p.z).view,D=(0,w.useCallback)(e=>{b.openSidebar(),M.activeSidebarTab(e)},[b,M]),_=(0,w.useCallback)(()=>{D("frame")},[D]),O=(0,w.useCallback)(()=>{D("outline")},[D]),[P,T]=(0,w.useState)(!1),B=(0,E.Xr)(N.Jr),R=(0,w.useCallback)(()=>(F.u4.$.header.history.open(),d.flavour===eD.j.AFFINE_CLOUD)?T(!0):B(!0),[B,d.flavour]),U=(0,E.Xr)(N.hX),A=(0,w.useCallback)(()=>{F.u4.$.header.pageInfo.open(),U(!0)},[U]),Y=(0,w.useCallback)(()=>{b.openDoc(i,{at:"new-tab"})},[i,b]),V=(0,w.useCallback)(()=>{b.openDoc(i,{at:"tail"})},[i,b]),X=(0,w.useCallback)(()=>{F.u4.$.header.docOptions.deleteDoc(),I({open:!0,pageIds:[i],pageTitles:[m.meta$.value.title??""]})},[m.meta$.value.title,i,I]),z=(0,w.useCallback)(()=>{e?.(),F.u4.$.header.docOptions.renameDoc()},[e]),W=(0,w.useCallback)(()=>{m.toggleMode(),F.u4.$.header.docOptions.switchPageMode({mode:"page"===v?"edgeless":"page"}),(0,o.oR)("page"===v?n["com.affine.toastMessage.edgelessMode"]():n["com.affine.toastMessage.pageMode"]())},[v,m,n]),H={padding:"4px 12px",transition:"all 0.3s"},Z=(0,w.useCallback)(e=>{e&&F.u4.$.header.docOptions.open()},[]),K=eY(m.blockSuiteDoc),q=(0,w.useCallback)(()=>{$(i),F.u4.$.header.docOptions.createDoc({control:"duplicate"})},[$,i]),G=(0,al.V)(async()=>{let e=await S();F.u4.$.header.docOptions.import(),e.isWorkspaceFile?F.u4.$.header.actions.createWorkspace({control:"import"}):F.u4.$.header.actions.createDoc({control:"import"})},[S]),J=(0,w.useCallback)(e=>{e&&F.u4.$.sharePanel.$.open()},[]),Q=(0,w.useCallback)(()=>{F.u4.$.header.docOptions.toggleFavorite(),C()},[C]),ee=(0,s.jsxs)(s.Fragment,{children:[l?(0,s.jsx)(e5.aC,{subContentOptions:{sideOffset:12,alignOffset:-8},items:(0,s.jsx)("div",{style:{padding:4},children:(0,s.jsx)(ah,{workspaceMetadata:d.meta,currentPage:a,onEnableAffineCloud:()=>c(d,{openPageId:a.id})})}),triggerOptions:{preFix:(0,s.jsx)(e5.ZB,{children:(0,s.jsx)(f.ShareIcon,{})})},subOptions:{onOpenChange:J},children:n["com.affine.share-menu.shareButton"]()}):null,(0,s.jsx)(e5.bX,{})]}),ea=(0,s.jsxs)(s.Fragment,{children:[l?ee:null,!t&&(0,s.jsx)(e5.Dr,{preFix:(0,s.jsx)(e5.ZB,{children:(0,s.jsx)(f.EditIcon,{})}),"data-testid":"editor-option-menu-rename",onSelect:z,style:H,children:n.Rename()}),(0,s.jsxs)(e5.Dr,{preFix:(0,s.jsx)(e5.ZB,{children:"page"===v?(0,s.jsx)(f.EdgelessIcon,{}):(0,s.jsx)(f.PageIcon,{})}),"data-testid":"editor-option-menu-edgeless",onSelect:W,style:H,children:[n["Convert to "](),"page"===v?n["com.affine.pageMode.edgeless"]():n["com.affine.pageMode.page"]()]}),(0,s.jsx)(e5.Dr,{"data-testid":"editor-option-menu-favorite",onSelect:Q,style:H,preFix:(0,s.jsx)(e5.ZB,{children:k?(0,s.jsx)(f.FavoritedIcon,{style:{color:"var(--affine-primary-color)"}}):(0,s.jsx)(f.FavoriteIcon,{})}),children:k?n["com.affine.favoritePageOperation.remove"]():n["com.affine.favoritePageOperation.add"]()}),(0,s.jsx)(e5.bX,{}),(0,s.jsx)(e5.Dr,{preFix:(0,s.jsx)(e5.ZB,{children:(0,s.jsx)(f.OpenInNewIcon,{})}),"data-testid":"editor-option-menu-open-in-new-tab",onSelect:Y,style:H,children:n["com.affine.workbench.tab.page-menu-open"]()}),environment.isDesktop&&(0,s.jsx)(e5.Dr,{preFix:(0,s.jsx)(e5.ZB,{children:(0,s.jsx)(f.SplitViewIcon,{})}),"data-testid":"editor-option-menu-open-in-split-new",onSelect:V,style:H,children:n["com.affine.workbench.split-view.page-menu-open"]()}),(0,s.jsx)(e5.bX,{}),(0,s.jsx)(e5.Dr,{preFix:(0,s.jsx)(e5.ZB,{children:(0,s.jsx)(f.InformationIcon,{})}),"data-testid":"editor-option-menu-info",onSelect:A,style:H,children:n["com.affine.page-properties.page-info.view"]()}),"page"===v?(0,s.jsx)(e5.Dr,{preFix:(0,s.jsx)(e5.ZB,{children:(0,s.jsx)(f.TocIcon,{})}),"data-testid":"editor-option-toc",onSelect:O,style:H,children:n["com.affine.header.option.view-toc"]()}):(0,s.jsx)(e5.Dr,{preFix:(0,s.jsx)(e5.ZB,{children:(0,s.jsx)(f.FrameIcon,{})}),"data-testid":"editor-option-frame",onSelect:_,style:H,children:n["com.affine.header.option.view-frame"]()}),(0,s.jsx)(e5.Dr,{preFix:(0,s.jsx)(e5.ZB,{children:(0,s.jsx)(f.HistoryIcon,{})}),"data-testid":"editor-option-menu-history",onSelect:R,style:H,children:n["com.affine.history.view-history-version"]()}),(0,s.jsx)(e5.bX,{}),!t&&(0,s.jsx)(e5.Dr,{preFix:(0,s.jsx)(e5.ZB,{children:(0,s.jsx)(f.DuplicateIcon,{})}),"data-testid":"editor-option-menu-duplicate",onSelect:q,style:H,children:n["com.affine.header.option.duplicate"]()}),(0,s.jsx)(e5.Dr,{preFix:(0,s.jsx)(e5.ZB,{children:(0,s.jsx)(f.ImportIcon,{})}),"data-testid":"editor-option-menu-import",onSelect:G,style:H,children:n.Import()}),(0,s.jsx)(eK.FN,{exportHandler:K,pageMode:v}),(0,s.jsx)(e5.bX,{}),(0,s.jsx)(eK.fB,{"data-testid":"editor-option-menu-delete",onSelect:X})]});return y?null:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e5.W1,{items:ea,contentOptions:{align:"center"},rootOptions:{onOpenChange:Z},children:(0,s.jsx)(ak,{})}),d.flavour===eD.j.AFFINE_CLOUD?(0,s.jsx)(eg,{docCollection:d.docCollection,open:P,pageId:i,onOpenChange:T}):null]})};var a$=t(39840);let aS=()=>{let{isPresent:e,handlePresent:a}=(0,a$.D)();return(0,s.jsx)(o.K0,{style:{flexShrink:0},size:"24",onClick:()=>a(!e),children:(0,s.jsx)(f.PresentationIcon,{})})},aI=({workspace:e,page:a})=>{let t=(0,eE.K)(),o=(0,w.useCallback)(e=>{e&&F.u4.$.sharePanel.$.open()},[]);return(0,s.jsx)(ay,{workspaceMetadata:e.meta,currentPage:a,onEnableAffineCloud:()=>t(e,{openPageId:a.id}),onOpenShareModal:o})};var aN=t(14862),aM=t(75806),aD=t(65423),aE="_198gvz10";let a_=(0,w.forwardRef)(({children:e,style:a,className:t},o)=>{let r=(0,E.md)(aN.XK);return(0,s.jsx)("div",{"data-testid":"header",style:a,className:t,ref:o,"data-sidebar-floating":r,children:e})});function aO({page:e,workspace:a}){let t=(0,w.useRef)(null),[r,i]=(0,w.useState)(0);(0,w.useEffect)(()=>{let e=t.current;if(e)return(0,o.vy)(e,e=>{i(e.contentRect.width)})},[]);let{hideShare:n,hideToday:l}=ab(r),c=P(a.docCollection,e?.id);return(0,s.jsxs)(a_,{className:aE,ref:t,children:[(0,s.jsx)(eW.EY,{title:c}),(0,s.jsx)(eW.tC,{icon:"journal"}),(0,s.jsx)(V.j,{pageId:e?.id}),(0,s.jsx)("div",{className:"_198gvz12",children:(0,s.jsx)(e9,{docCollection:a.docCollection,page:e})}),l?null:(0,s.jsx)(e4,{docCollection:a.docCollection}),(0,s.jsx)(aD.L,{}),(0,s.jsx)(aC,{isJournal:!0,page:e,containerWidth:r}),e&&!n?(0,s.jsx)(aI,{workspace:a,page:e}):null]})}function aP({page:e,workspace:a}){let t=(0,w.useRef)(null),r=(0,w.useRef)(null),[i,n]=(0,w.useState)(0);(0,w.useEffect)(()=>{let e=r.current;if(e)return(0,o.vy)(e,e=>{n(e.contentRect.width)})},[]);let{hideCollect:l,hideShare:c,hidePresent:d,showDivider:p}=ab(i),u=(0,w.useCallback)(()=>{setTimeout(()=>t.current?.triggerEdit())},[]),m=P(a.docCollection,e?.id),f=(0,h.h1)(g.s).doc,j=(0,x.S)(f.mode$),y=(0,w.useCallback)(()=>{F.u4.$.header.actions.renameDoc()},[]);return(0,s.jsxs)(a_,{className:aE,ref:r,children:[(0,s.jsx)(eW.EY,{title:m}),(0,s.jsx)(eW.tC,{icon:j??"page"}),(0,s.jsx)(V.j,{pageId:e?.id}),(0,s.jsx)(aM.b,{inputHandleRef:t,pageId:e?.id,docCollection:a.docCollection,onEditSave:y}),(0,s.jsxs)("div",{className:"_198gvz13",children:[l?null:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(eG,{pageId:e?.id}),(0,s.jsx)(eJ,{})]}),(0,s.jsx)(aC,{rename:u,page:e,containerWidth:i})]}),(0,s.jsx)("div",{className:"_198gvz11"}),d?null:(0,s.jsx)(aS,{}),e&&!c?(0,s.jsx)(aI,{workspace:a,page:e}):null,p?(0,s.jsx)(o.cG,{orientation:"vertical",style:{height:20,marginLeft:4}}):null]})}function aF(e){let{page:a,workspace:t}=e,{isJournal:o}=(0,_.Bn)(a.collection,a.id),r=a.meta?.trash,[i,n]=(0,E.fp)(N.hX);return!function({workspaceMeta:e,docId:a}){let t=(0,eW.Tq)(),s=e.id,o=e.flavour===eD.j.AFFINE_CLOUD,{onClickCopyLink:r}=ar({workspaceId:s,pageId:a,urlType:"workspace"});(0,w.useEffect)(()=>{let e=[];return e.push((0,eT.uu)({id:`affine:share-private-link:${a}`,category:"affine:general",preconditionStrategy:eT.ON.Never,keyBinding:{binding:"$mod+Shift+c"},label:"",icon:null,run(){F.u4.$.cmdk.general.copyShareLink({type:"private"}),t&&o&&r()}})),()=>{e.forEach(e=>e())}},[a,t,o,r])}({workspaceMeta:t.meta,docId:a.id}),(0,s.jsxs)(s.Fragment,{children:[o&&!r?(0,s.jsx)(aO,{...e}):(0,s.jsx)(aP,{...e}),(0,s.jsx)(eZ.Wh,{open:i,onOpenChange:n,docId:a.id})]})}a_.displayName="forwardRef(Header)";var aT=t(52153);let aB=({editor:e})=>{let a=(0,w.useRef)(null),t=(0,w.useCallback)(e=>{e&&((0,M.Z1)(a.current,"frame panel should be initialized"),e.append(a.current))},[]);if(e)return a.current||(a.current=new aT.oD),e!==a.current?.editor&&(a.current.editor=e,a.current.fitPadding=[20,20,20,20]),(0,s.jsx)("div",{className:"_1nrashj0",ref:t})};var aL=t(50822),aR="uiyc497";let aU=({count:e,max:a=99,...t})=>(0,s.jsx)("span",{...t,children:e>a?`${a}+`:e}),aA=({docRecord:e,right:a,className:t,...o})=>{let r=(0,x.S)(e.mode$),i=(0,h.h1)(j.j).workspace,n=P(i.docCollection,e.id),{isJournal:l}=(0,_.Bn)(i.docCollection,e.id),c=l?f.TodayIcon:"edgeless"===r?f.EdgelessIcon:f.PageIcon;return(0,s.jsxs)(eW.Sj,{"aria-label":n,to:`/${e.id}`,className:(0,k.A)(t,"uiyc49a uiyc490"),...o,children:[(0,s.jsx)("div",{className:"uiyc49b",children:(0,s.jsx)(c,{width:20,height:20})}),(0,s.jsx)("span",{className:"uiyc49c",children:n}),a]})},aY=()=>{let e=(0,L.s9)(),a=(0,h.h1)(g.s).doc,t=(0,h.h1)(j.j).workspace,{journalDate:r,isJournal:i}=(0,_.Bn)(t.docCollection,a.id),{openJournal:n}=(0,_.mM)(t.docCollection),[l,c]=(0,w.useState)(e0()().format("YYYY-MM-DD"));(0,w.useEffect)(()=>{r&&c(r.format("YYYY-MM-DD"))},[r]);let d=(0,w.useCallback)(e=>{r&&e0()(e).isSame(e0()(r))||n(e)},[r,n]),p=(0,w.useCallback)(e=>(0,s.jsxs)("button",{className:"uiyc49g uiyc490","data-is-date-cell":!0,tabIndex:e.focused?0:-1,"data-is-today":e.isToday,"data-not-current-month":e.notCurrentMonth,"data-selected":e.selected,"data-is-journal":i,"data-has-journal":!1,children:[e.label,null]}),[i]);return(0,s.jsxs)("div",{className:"uiyc492","data-is-journal":i,children:[(0,s.jsx)("div",{className:"uiyc491",children:(0,s.jsx)(o.lr,{weekDays:e["com.affine.calendar-date-picker.week-days"](),monthNames:e["com.affine.calendar-date-picker.month-names"](),todayLabel:e["com.affine.calendar-date-picker.today"](),customDayRenderer:p,value:l,onChange:d})}),(0,s.jsx)(aH,{date:e0()(l)}),(0,s.jsx)(az,{date:e0()(l)})]})},aV=(e,a,t="desc")=>[...e].sort((e,s)=>("asc"===t?1:-1)*e0()(s.meta$.value[a]).diff(e0()(e.meta$.value[a]))),aX=({name:e})=>{let a=(0,L.s9)();return(0,s.jsx)("div",{className:"uiyc499",children:"createdToday"===e?a["com.affine.journal.daily-count-created-empty-tips"]():a["com.affine.journal.daily-count-updated-empty-tips"]()})},az=({date:e})=>{let a=(0,w.useRef)(null),t=(0,L.s9)(),[r,i]=(0,w.useState)("createdToday"),n=(0,x.S)((0,h.h1)(b.F).list.docs$),l=(0,w.useCallback)(a=>aV(n.filter(t=>{let s=t.meta$.value;return!s.trash&&s[a]&&e0()(s[a]).isSame(e,"day")}),a),[e,n]),c=(0,w.useMemo)(()=>l("createDate"),[l]),d=(0,w.useMemo)(()=>l("updatedDate"),[l]),p=(0,w.useMemo)(()=>[{name:"createdToday",label:t["com.affine.journal.created-today"](),count:c.length},{name:"updatedToday",label:t["com.affine.journal.updated-today"](),count:d.length}],[c.length,t,d.length]),u=p.findIndex(({name:e})=>e===r),m=(0,aL.D)({"--active-index":String(u),"--item-count":String(p.length)});return(0,s.jsxs)("div",{className:"uiyc493",style:m,children:[(0,s.jsx)("header",{className:"uiyc494",children:p.map(({label:e,count:a,name:t},o)=>(0,s.jsxs)("button",{onClick:()=>i(t),"aria-selected":r===t,className:"uiyc495 uiyc490",children:[e," ",(0,s.jsx)(aU,{count:a})]},o))}),(0,s.jsx)("main",{className:"uiyc496","data-active":r,children:p.map(({name:e})=>{let t="createdToday"===e?c:d;return 0===t.length?(0,s.jsx)("div",{className:aR,children:(0,s.jsx)(aX,{name:e})},e):(0,s.jsxs)(o.yE.Root,{className:aR,children:[(0,s.jsx)(o.yE.Scrollbar,{}),(0,s.jsx)(o.yE.Viewport,{children:(0,s.jsx)("div",{className:"uiyc498",ref:a,children:t.map((a,t)=>(0,s.jsx)(aA,{tabIndex:e===r?0:-1,docRecord:a},t))})})]},e)})})]})},aW=({docRecords:e,children:a,className:t,...r})=>{let i=(0,h.h1)(j.j).workspace,n=(0,h.h1)(g.s).doc,{setTrashModal:l}=(0,eV.T)(i.docCollection),c=(0,w.useCallback)(e=>{l({open:!0,pageIds:[e.id],pageTitles:[e.title$.value]})},[l]);return(0,s.jsxs)("div",{className:(0,k.A)("uiyc49e",t),...r,children:[e.map(e=>{let a=e.id===n.id;return(0,s.jsx)(aA,{"aria-selected":a,docRecord:e,right:(0,s.jsx)(o.W1,{items:(0,s.jsx)(eK.fB,{onSelect:()=>c(e)}),children:(0,s.jsx)(o.K0,{children:(0,s.jsx)(f.MoreHorizontalIcon,{})})})},e.id)}),a]})},aH=({date:e})=>{let a=(0,L.s9)(),t=(0,h.h1)(j.j).workspace,r=(0,h.h1)(b.F).list,i=(0,_.lx)(t.docCollection).getJournalsByDate(e.format("YYYY-MM-DD")),n=(0,x.S)(r.docs$.map(e=>e.filter(e=>i.some(a=>a.id===e.id))));return i.length<=1?null:(0,s.jsx)(aW,{className:"uiyc49d",docRecords:n.slice(0,5),children:i.length>5?(0,s.jsx)(o.W1,{items:(0,s.jsx)(aW,{docRecords:n.slice(5)}),children:(0,s.jsx)("div",{className:"uiyc49f uiyc490",children:a["com.affine.journal.conflict-show-more"]({count:(n.length-5).toFixed(0)})})}):null})},aZ=({editor:e})=>{let a=(0,w.useRef)(null),t=(0,w.useCallback)(e=>{if(e){if(null===a.current){console.error("outline panel should be initialized");return}e.append(a.current)}},[]);if(e)return a.current||(a.current=new aT.bP),e!==a.current?.editor&&(a.current.editor=e,a.current.fitPadding=[20,20,20,20]),(0,s.jsx)("div",{className:"_1je7lp20",ref:t})},aK=(0,w.memo)(function(){let e=(0,h.h1)(eW.TR).workbench,a=(0,h.h1)(p.z).view,t=(0,x.S)(a.activeSidebarTab$),r=(0,h.h1)(g.s).doc,d=(0,x.S)(r.meta$.map(e=>e.trash)),{openPage:b,jumpToPageBlock:C,jumpToTag:S}=(0,eb.P)(),[I,M]=(0,w.useState)(null),D=(0,h.h1)(j.j).workspace,_=(0,h.h1)(y.q).globalContext,O=D.docCollection,P=(0,x.S)(r.mode$),T=(0,x.S)(e.sidebarOpen$),{appSettings:B}=(0,l.V)(),{setDocReadonly:R}=(0,c.B)(D.docCollection),U=(0,eW.Tq)(),[Y,V]=(0,eX.U)();(0,w.useEffect)(()=>{U&&V(I)},[I,U,V]),(0,w.useEffect)(()=>{let t=i.uj.slots.requestOpenWithChat.on(()=>{e.openSidebar(),a.activeSidebarTab("journal")});return()=>t.dispose()},[t,a,e]),(0,w.useEffect)(()=>{if(U)return _.docId.set(r.id),_.isDoc.set(!0),()=>{_.docId.set(null),_.isDoc.set(!1)}},[r,_,U]),(0,w.useEffect)(()=>{if(U)return _.docMode.set(P),()=>{_.docMode.set(null)}},[r,_,U,P]),(0,w.useEffect)(()=>{"isMobile"in environment&&environment.isMobile&&R(r.id,!0)},[r.id,R]),(0,w.useEffect)(()=>{if(U)return _.isTrashDoc.set(!!d),()=>{_.isTrashDoc.set(null)}},[_,U,d]),function(){let e=(0,h.h1)(g.s).doc,a=e.id,t=(0,x.S)(e.mode$),r=(0,L.s9)(),i=(0,h.h1)(j.j).workspace,n=i.docCollection,l=(0,h.h1)(eB.Mn),c=(0,x.S)(l.isFavorite$(a,"doc")),d=(0,x.S)(e.trash$),p=(0,E.Xr)(A),u=(0,E.Xr)(N.hX),m=(0,w.useCallback)(()=>{p(()=>({pageId:a,open:!0}))},[a,p]),y=(0,w.useCallback)(()=>{u(!0)},[u]),{duplicate:v}=(0,ev._)(n),b=eY(e.blockSuiteDoc),{setTrashModal:k}=(0,eV.T)(n),C=(0,w.useCallback)(e=>{k({open:!0,pageIds:[a],pageTitles:[e]})},[a,k]),$=i.flavour===eD.j.AFFINE_CLOUD;(0,w.useEffect)(()=>{let i=[],n=()=>eT.ON.InPaperOrEdgeless&&!d;return i.push((0,eT.uu)({id:`editor:${t}-view-info`,preconditionStrategy:()=>eT.ON.InPaperOrEdgeless&&!d&&!0,category:`editor:${t}`,icon:"page"===t?(0,s.jsx)(f.PageIcon,{}):(0,s.jsx)(f.EdgelessIcon,{}),label:r["com.affine.page-properties.page-info.view"](),run(){F.u4.$.cmdk.docInfo.open(),y()}})),i.push((0,eT.uu)({id:`editor:${t}-${c?"remove-from":"add-to"}-favourites`,preconditionStrategy:n,category:`editor:${t}`,icon:"page"===t?(0,s.jsx)(f.PageIcon,{}):(0,s.jsx)(f.EdgelessIcon,{}),label:c?r["com.affine.favoritePageOperation.remove"]():r["com.affine.favoritePageOperation.add"](),run(){l.toggle(a,"doc"),F.u4.$.cmdk.editor.toggleFavorite(),(0,o.oR)(c?r["com.affine.cmdk.affine.editor.remove-from-favourites"]():r["com.affine.cmdk.affine.editor.add-to-favourites"]())}})),i.push((0,eT.uu)({id:`editor:${t}-convert-to-${"page"===t?"edgeless":"page"}`,preconditionStrategy:n,category:`editor:${t}`,icon:"page"===t?(0,s.jsx)(f.PageIcon,{}):(0,s.jsx)(f.EdgelessIcon,{}),label:`${r["Convert to "]()}${"page"===t?r["com.affine.pageMode.edgeless"]():r["com.affine.pageMode.page"]()}`,run(){F.u4.$.cmdk.editor.switchPageMode({mode:"page"===t?"edgeless":"page"}),e.toggleMode(),(0,o.oR)("page"===t?r["com.affine.toastMessage.edgelessMode"]():r["com.affine.toastMessage.pageMode"]())}})),i.push((0,eT.uu)({id:`editor:${t}-duplicate`,preconditionStrategy:n,category:`editor:${t}`,icon:"page"===t?(0,s.jsx)(f.PageIcon,{}):(0,s.jsx)(f.EdgelessIcon,{}),label:r["com.affine.header.option.duplicate"](),run(){v(a),F.u4.$.cmdk.editor.createDoc({control:"duplicate"})}})),i.push((0,eT.uu)({id:`editor:${t}-export-to-pdf`,preconditionStrategy:()=>"page"===t&&!d,category:`editor:${t}`,icon:"page"===t?(0,s.jsx)(f.PageIcon,{}):(0,s.jsx)(f.EdgelessIcon,{}),label:r["Export to PDF"](),async run(){F.u4.$.cmdk.editor.export({type:"pdf"}),await b("pdf")}})),i.push((0,eT.uu)({id:`editor:${t}-export-to-html`,preconditionStrategy:n,category:`editor:${t}`,icon:"page"===t?(0,s.jsx)(f.PageIcon,{}):(0,s.jsx)(f.EdgelessIcon,{}),label:r["Export to HTML"](),async run(){F.u4.$.cmdk.editor.export({type:"html"}),await b("html")}})),i.push((0,eT.uu)({id:`editor:${t}-export-to-png`,preconditionStrategy:()=>"page"===t&&!d,category:`editor:${t}`,icon:"page"===t?(0,s.jsx)(f.PageIcon,{}):(0,s.jsx)(f.EdgelessIcon,{}),label:r["Export to PNG"](),async run(){F.u4.$.cmdk.editor.export({type:"png"}),await b("png")}})),i.push((0,eT.uu)({id:`editor:${t}-export-to-markdown`,preconditionStrategy:n,category:`editor:${t}`,icon:"page"===t?(0,s.jsx)(f.PageIcon,{}):(0,s.jsx)(f.EdgelessIcon,{}),label:r["Export to Markdown"](),async run(){F.u4.$.cmdk.editor.export({type:"markdown"}),await b("markdown")}})),i.push((0,eT.uu)({id:`editor:${t}-move-to-trash`,preconditionStrategy:n,category:`editor:${t}`,icon:"page"===t?(0,s.jsx)(f.PageIcon,{}):(0,s.jsx)(f.EdgelessIcon,{}),label:r["com.affine.moveToTrash.title"](),run(){F.u4.$.cmdk.editor.deleteDoc(),C(e.title$.value)}})),i.push((0,eT.uu)({id:`editor:${t}-restore-from-trash`,preconditionStrategy:()=>eT.ON.InPaperOrEdgeless&&d,category:`editor:${t}`,icon:"page"===t?(0,s.jsx)(f.PageIcon,{}):(0,s.jsx)(f.EdgelessIcon,{}),label:r["com.affine.cmdk.affine.editor.restore-from-trash"](),run(){F.u4.$.cmdk.editor.restoreDoc(),e.restoreFromTrash()}})),$&&i.push((0,eT.uu)({id:`editor:${t}-page-history`,category:`editor:${t}`,icon:(0,s.jsx)(f.HistoryIcon,{}),label:r["com.affine.cmdk.affine.editor.reveal-page-history-modal"](),run(){F.u4.$.cmdk.docHistory.open(),m()}})),i.push((0,eT.uu)({id:"alert-ctrl-s",category:"affine:general",preconditionStrategy:eT.ON.Never,keyBinding:{binding:"$mod+s"},label:"",icon:null,run(){(0,o.oR)(r.Save())}})),()=>{i.forEach(e=>e())}},[c,t,C,b,r,d,$,m,v,l,a,e,y])}();let X=(0,x.S)(r.title$);(0,ez.k)(X);let z=(0,w.useCallback)((e,a)=>{try{let a=e.getBlockByFlavour("affine:surface")[0];a&&"$blocksuite:internal:native$"!==a.yBlock.get("prop:elements").get("type")&&v.G.upgradeDoc(0,{"affine:surface":3},e.spaceDoc)}catch{}let t=a.host;t?.std.clipboard.use(u.xqQ("/api/worker/image-proxy")),u.mFI.setImageProxyURL("/api/worker/image-proxy"),u.dYB.setLinkPreviewEndpoint("/api/worker/link-preview"),u.dyY.setLinkPreviewEndpoint("/api/worker/link-preview"),u.J3u.setLinkPreviewEndpoint("/api/worker/link-preview"),u.PoU.setLinkPreviewEndpoint("/api/worker/link-preview");let s=t?.std.spec.getService("affine:page"),o=new m.K;return s&&(o.add(s.slots.docLinkClicked.on(({docId:e,blockId:a})=>a?C(O.id,e,a):b(O.id,e))),o.add(s.slots.tagClicked.on(({tagId:e})=>{S(D.id,e)}))),M(a),()=>{o.dispose()}},[C,O.id,b,S,D.id]),[W,H]=(0,o.IF)(),Z=environment.isDesktop,K=(0,w.useCallback)(()=>{e.openSidebar(),a.activeSidebarTab("outline")},[e,a]);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(eW.XP,{children:(0,s.jsx)(aF,{page:r.blockSuiteDoc,workspace:D})}),(0,s.jsx)(eW.s$,{children:(0,s.jsxs)("div",{className:"igi9w50","data-dynamic-top-border":Z,"data-has-scroll-top":H,children:[(0,s.jsxs)($.E,{children:[(0,s.jsx)(eF,{pageId:r.id,workspace:D}),(0,s.jsxs)(o.yE.Root,{children:[(0,s.jsx)(o.yE.Viewport,{ref:W,className:(0,k.A)("affine-page-viewport","igi9w52","igi9w51"),children:(0,s.jsx)(ey.q,{pageId:r.id,onLoad:z,docCollection:O})}),(0,s.jsx)(o.yE.Scrollbar,{className:(0,k.A)({igi9w53:!B.clientBorder})})]}),(0,s.jsx)(n.E,{editor:I,show:"page"===P&&!T,openOutlinePanel:K})]},r.id),d?(0,s.jsx)(eS,{}):null]})}),(0,s.jsx)(eW.$Q,{tabId:"journal",icon:(0,s.jsx)(f.TodayIcon,{}),children:(0,s.jsx)(aY,{})}),(0,s.jsx)(eW.$Q,{tabId:"outline",icon:(0,s.jsx)(f.TocIcon,{}),children:(0,s.jsx)(aZ,{editor:I})}),(0,s.jsx)(eW.$Q,{tabId:"frame",icon:(0,s.jsx)(f.FrameIcon,{}),children:(0,s.jsx)(aB,{editor:I})}),(0,s.jsx)(ej,{})]})}),aq=({pageId:e})=>{let a=(0,h.h1)(j.j).workspace,t=(0,h.h1)(b.F),o=t.list,i=(0,x.S)(o.isReady$),n=(0,x.S)(o.doc$(e)),[l,c]=(0,w.useState)(null);(0,w.useLayoutEffect)(()=>{if(!n)return;let{doc:a,release:s}=t.open(e);return c(a),()=>{s()}},[n,t,e]),(0,w.useEffect)(()=>(a.engine.doc.setPriority(e,10),()=>{a.engine.doc.setPriority(e,5)}),[a,e]);let d=(0,x.S)(l?.meta$.map(e=>e.trash));return((0,w.useEffect)(()=>{l&&d&&a.docCollection.awarenessStore.setReadonly(l.blockSuiteDoc.blockCollection,!0)},[a.docCollection.awarenessStore,l,d]),i&&!l)?(0,s.jsx)(eH.PageNotFound,{noPermission:!0}):l?(0,s.jsx)(h.xc,{scope:l.scope,children:(0,s.jsx)(aK,{})}):(0,s.jsx)(r.g,{},"current-page-is-null")},aG=()=>{ek.xG.debug("DetailPage");let e=(0,C.g)(),a=(0,h.h1)(d.Oq);(0,w.useEffect)(()=>{if(e.pageId){let t=e.pageId;localStorage.setItem("last_page_id",t),a.addRecentDoc(t)}},[e,a]);let t=e.pageId;return t?(0,s.jsx)(aq,{pageId:t}):null}}}]);
//# sourceMappingURL=chunk.653.a6924842.js.map